<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASPAN Terminal</title>
    <style>
    /* CSS Variables */
    :root {
        --bg: #0d1117;
        --card: #161b22;
        --text: #c9d1d9;
        --accent: #58a6ff;
        --accent2: #ffa657;
        --green: #56d364;
        --border: #30363d;
    }

    /* Body */
    body {
        font-family: 'Segoe UI', Tahoma, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 20px 10px;
        animation: fadeIn 1s ease-out;
    }

    /* H1 */
    h1 {
        text-align: center;
        font-size: 3em;
        font-weight: 900;
        background: linear-gradient(90deg, #00f5ff, #ff00ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 30px;
    }

    /* Controls */
    .controls {
        background: var(--card);
        border-radius: 20px;
        padding: 25px;
        margin: 30px auto;
        max-width: 95%;
        width: 95%;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        box-shadow: 0 10px 35px rgba(0,0,0,0.6);
        border: 2px solid var(--border);
        animation: slideUp 0.8s ease-out forwards;
        opacity: 0;
        transform: translateY(30px);
    }

    /* Select, Button, Input */
    select, button, input {
        background: var(--bg);
        color: var(--text);
        border: 2px solid var(--border);
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 1.1em;
        transition: all 0.3s;
        font-family: 'Segoe UI', sans-serif;
    }

    button {
        background: linear-gradient(90deg, var(--accent), #79c0ff);
        color: #000;
        font-weight: bold;
        border: none;
        cursor: pointer;
    }

    button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(88,166,255,0.3);
    }

    /* Table */
    table {
        background: var(--card);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 35px rgba(0,0,0,0.6);
        border: 2px solid var(--border);
        margin: 30px auto;
        max-width: 95%;
        width: 95%;
        animation: slideUp 0.8s ease-out forwards 0.2s;
        opacity: 0;
        transform: translateY(30px);
    }

    th {
        background: linear-gradient(90deg, var(--accent), #79c0ff);
        color: #000;
        font-weight: bold;
        padding: 15px 10px;
        font-size: 1em;
    }
    
    td {
        padding: 12px 8px;
        font-size: 1em;
    }

    tr:hover {
        background: rgba(88, 166, 255, 0.1);
    }

    /* Spread Calc */
    .spread-calc {
        background: var(--card);
        border-radius: 20px;
        padding: 30px;
        margin: 30px auto;
        max-width: 95%;
        width: 95%;
        box-shadow: 0 10px 35px rgba(0,0,0,0.6);
        border: 2px solid var(--border);
        animation: slideUp 0.8s ease-out forwards 0.4s;
        opacity: 0;
        transform: translateY(30px);
    }

    /* Footer */
    .footer {
        text-align: center;
        padding: 20px 0;
        color: #8b949e;
        font-size: 0.95em;
        border-top: 1px solid var(--border);
        margin-top: 30px;
    }

    /* Toggle Calc Buttons */
    .toggle-calc-btn {
        padding: 12px 20px;
        font-size: 1.1em;
        border-radius: 12px;
        border: none;
        color: white;
        cursor: pointer;
        margin: 0 5px;
        height: 48px;
        box-sizing: border-box;
        font-weight: bold;
        transition: all 0.3s;
    }

    .toggle-calc-btn.calc-closed {
        background: linear-gradient(90deg, #238636, #2ea043);
    }

    .toggle-calc-btn.calc-closed:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(35,134,54,0.3);
    }

    .toggle-calc-btn.calc-open {
        background: linear-gradient(90deg, #da3633, #f85149);
    }

    .toggle-calc-btn.calc-open:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(218,54,51,0.3);
    }

    /* PNL Calc Button */
    .pnl-calc-btn {
        padding: 12px 20px;
        font-size: 1.1em;
        border-radius: 12px;
        border: none;
        background: linear-gradient(90deg, #ffa657, #ffb87a);
        color: black;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        height: 48px;
        box-sizing: border-box;
        font-weight: bold;
    }

    .pnl-calc-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255,166,87,0.3);
    }

    /* Other Styles */
    .update { text-align: center; color: #ffa657; font-weight: bold; font-size: 1.1em; }

    .sound-control { text-align: center; margin: 15px 0; color: #ffa657; font-size: 1.2em; }
    .sound-control input { width: 90px; }

    .calc-result { margin-top: 20px; padding: 15px; background: #21262d; border-radius: 12px; font-size: 1.1em; line-height: 1.8; }

    .ticker { color: #58a6ff; font-weight: bold; cursor: pointer; text-decoration: underline; }
    .ticker:hover { color: #79c0ff; }

    .spchart-btn {
        background: #000000;
        color: white;
        padding: 8px 14px;
        border-radius: 6px;
        font-size: 0.9em;
        cursor: pointer;
        margin: 0 2px;
    }
    .spchart-btn:hover {
        background: #c084fc;
        color: black;
        font-weight: bold;
    }
    
    .calc-btn { background: #8b5cf6; padding: 8px 14px; border-radius: 6px; font-size: 0.9em; cursor: pointer; }
    .calc-btn:hover { background: #c084fc; color: black; font-weight: bold; }

    .direction { display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; font-weight: bold; font-size: 0.85em; }
    .long { background: #166534; color: white; padding: 3px 6px; border-radius: 4px; }
    .short { background: #7f1d1d; color: white; padding: 3px 6px; border-radius: 4px; }

    .real-profit { background: rgba(34, 197, 94, 0.3) !important; animation: realGlow 1.5s infinite alternate; }
    @keyframes realGlow { from { box-shadow: 0 0 15px #34d399; } to { box-shadow: 0 0 25px #34d399; } }

    .lime { color: #7ffe94 !important; font-weight: bold; }
    .green { color: #56d364 !important; font-weight: bold; }
    .red { color: #ff7b72; font-weight: bold; }
    .copied { position: fixed; top: 20px; right: 20px; background: #238636; color: white; padding: 15px 30px; border-radius: 12px; z-index: 9999; opacity: 0; transition: opacity 0.4s; font-weight: bold; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

    /* Анимации */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

    /* Для десктопов - фиксированная максимальная ширина */
    @media (min-width: 768px) {
        .controls, table, .spread-calc {
            max-width: 1800px;
            width: 95%;
            margin-left: auto;
            margin-right: auto;
        }
    }

    /* Мобильная адаптация */
    @media (max-width: 768px) {
        body { padding: 10px; font-size: 14px; }
        h1 { font-size: 1.2em; margin: 5px; }
        
        .controls { display: flex; flex-direction: column; gap: 10px; }
        .controls select, .controls button, .controls input, .controls a { 
            width: 100%; 
            margin: 0;
            box-sizing: border-box;
        }
        
        .sound-control { font-size: 1em; }
        .sound-control input { width: 80px; }
        
        .toggle-calc-btn { width: 100%; margin: 0; box-sizing: border-box; text-align: center; }
        .pnl-calc-btn { width: 100%; margin: 0; box-sizing: border-box; text-align: center; display: block; }
        
        .spread-calc { padding: 15px; margin: 10px auto; }
        .calc-result { font-size: 0.9em; padding: 10px; }
        
        table { font-size: 0.8em; display: block; overflow-x: auto; white-space: nowrap; }
        th, td { padding: 8px 3px; }
        
        /* Скрываем кнопки и менее важные колонки на мобильных */
        /* Скрываем: spchart, Calc, Bybit rate, Binance rate */
        th:nth-child(2), td:nth-child(2),  /* spchart */
        th:nth-child(3), td:nth-child(3),  /* Calc */
        th:nth-child(9), td:nth-child(9),   /* Bybit rate */
        th:nth-child(10), td:nth-child(10)  /* Binance rate */
        {
            display: none;
        }
        
        /* Оставляем: Пара, Спред 8ч, Чистый, Бонус вход, Итого, Направление, Bybit funding, Binance funding */
        
        .direction { font-size: 0.75em; }
        
        .footer { font-size: 0.8em; }
        .copied { padding: 10px 20px; font-size: 0.9em; }
    }

    @media (max-width: 480px) {
        body { padding: 5px; font-size: 12px; }
        h1 { font-size: 1em; }
        
        .controls select, .controls button, .controls input, .controls a {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        table { font-size: 0.7em; }
        th, td { padding: 6px 2px; }
        
        .footer { font-size: 0.7em; }
    }

    /* Стили для игнор-листа */
    #ignore-list {
        background: #21262d;
        color: white;
        border: 2px solid #30363d;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 16px;
        width: 200px;
    }

    #ignore-status {
        text-align: center;
        margin-top: 10px;
        font-size: 0.9em;
        color: #8b949e;
    }

    /* Стиль для игнорируемых строк */
    .ignored-row {
        opacity: 0.6;
        filter: grayscale(70%);
    }

    /* Стиль для текста "игнорируется" */
    .ignore-tag {
        background: #ff7b72;
        color: white;
        font-size: 0.7em;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 5px;
        vertical-align: middle;
    }

    /* Для мобильной версии */
    @media (max-width: 768px) {
        .sound-control {
            flex-direction: column;
            gap: 10px;
        }
        
        #ignore-list {
            width: 100%;
            margin: 5px 0;
        }
    }
</style>
</head>
<body>
    <script>
// Проверка авторизации при загрузке
if (!localStorage.getItem('user_id') || localStorage.getItem('user_role') !== 'admin') {
    window.location.href = 'index.html';
}
</script>

<!-- Кнопка выхода -->
<button onclick="logout()" style="position:fixed; top:20px; right:20px; padding:10px 20px; border-radius:12px; border:none; background:linear-gradient(90deg, #ff7b72, #ff9999); color:white; font-weight:bold; cursor:pointer; z-index:10000;">Выход</button>

    <h1>ASPAN Terminal</h1>
    <div class="update" id="last-update">Обновлено: —</div>

    <div class="controls">
        <select id="limit-select">
            <option value="5">ТОП-5</option>
            <option value="10" selected>ТОП-10</option>
            <option value="15">ТОП-15</option>
            <option value="25">ТОП-25</option>
            <option value="50">ТОП-50</option>
            <option value="9999">ВСЕ</option>
        </select>
        <button onclick="updateNow()">Обновить</button>
        <button class="toggle-calc-btn calc-closed" onclick="toggleCalculator()">Открыть калькулятор</button>
        <a href="https://artofskill.github.io/spread_alert.html" target="_blank" class="pnl-calc-btn">Spread PNL Calc</a>
    </div>

    <!-- Фильтр звука + Игнор-лист -->
    <div class="sound-control">
        <div style="display: flex; align-items: center; gap: 20px; justify-content: center; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 10px;">
                Звук при Итого ≥ <input type="number" id="sound-threshold" step="0.1" value="2.5" style="width:90px;"> %
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px; margin-left: 20px;">
                <span style="color:#ffa657;">Игнор-лист:</span>
                <input type="text" id="ignore-list" placeholder="BTC ETH SOL" style="width:200px;">
                <button onclick="updateIgnoreList()">Игнор</button>
                <button onclick="openIgnoreModal()" style="background: linear-gradient(90deg, #6e40c9, #8957e5);">Показать игнор-лист</button>
            </div>
        </div>
        <div id="ignore-status" style="margin-top: 10px; color: #8b949e; font-size: 0.9em;">
            Игнорируется: <span id="ignore-count">0</span> тикеров
        </div>
        <div id="ignore-suggestions" style="margin-top: 5px; font-size: 0.8em; color: #8b949e;">
            Можно вводить несколько тикеров через пробел
        </div>
    </div>

    <div class="spread-calc" style="display:none;">
        <div style="margin-bottom:10px; color:#ffa657;">Введи тикер (например BTC, PEPE, SOON)</div>
        <input type="text" id="ticker-input" placeholder="SOON" autofocus>
        <button onclick="calcSpread()">Анализ</button>
        <div class="calc-result" id="calc-result">Результат появится здесь</div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="font-size: 1.1em;">Пара</th>
                <th style="font-size: 1.1em;">spchart</th>
                <th style="font-size: 1.1em;">Calc</th>
                <th style="font-size: 1.1em; cursor:pointer; user-select:none;" onclick="setSort('realFund')" id="th-realFund">Real Fund ↕</th>
                <th style="font-size: 1.1em;">Fund-fee</th>
                <th style="font-size: 1.1em; cursor:pointer; user-select:none;" onclick="setSort('entryBonus')" id="th-entryBonus">Спред<br>текущий ↕</th>
                <th style="font-size: 1.1em; cursor:pointer; user-select:none;" onclick="setSort('totalProfit')" id="th-totalProfit">Итого ≈ ↕</th>
                <th style="font-size: 1.1em;">Направление</th>
                <th style="font-size: 1.1em;">Bybit<br>rate</th>
                <th style="font-size: 1.1em;">Binance<br>rate</th>
                <th style="font-size: 1.1em;">Bybit<br>funding</th>
                <th style="font-size: 1.1em;">Binance<br>funding</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <div class="footer">
        Клик по паре — копирует тикер | Shift+клик — с USDT | Calc — полный анализ<br>
        spchart — график спреда (Binance - Bybit)<br>
        <span id="clock"></span>
    </div>

    <div class="copied" id="copied">Скопировано!</div>

<!-- Модальное окно игнор-листа -->
<div id="ignore-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#161b22; border:2px solid #30363d; border-radius:20px; padding:30px; width:90%; max-width:500px; max-height:80vh; display:flex; flex-direction:column; gap:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color:#c9d1d9; font-size:1.3em;">Игнор-лист</h2>
            <span onclick="closeIgnoreModal()" style="cursor:pointer; color:#8b949e; font-size:1.5em; line-height:1;">✕</span>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="modal-ignore-input" placeholder="Добавить тикер (BTC ETH...)" style="flex:1; background:#0d1117; color:#c9d1d9; border:2px solid #30363d; padding:10px 15px; border-radius:12px; font-size:1em;">
            <button onclick="modalAddTicker()" style="white-space:nowrap;">Добавить</button>
        </div>
        <div id="modal-ignore-list" style="overflow-y:auto; display:flex; flex-wrap:wrap; gap:8px; max-height:50vh; padding:5px 0;"></div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button onclick="if(confirm('Очистить весь игнор-лист?')){ignoreList=[];saveIgnoreList();updateIgnoreUI();renderModalIgnoreList();}" style="background:linear-gradient(90deg,#da3633,#f85149);">Очистить всё</button>
            <button onclick="closeIgnoreModal()">Закрыть</button>
        </div>
    </div>
</div>

<script>
// Функция выхода
function logout() {
    localStorage.clear();
    window.location.href = 'index.html';
}

// Проверка авторизации при загрузке
if (!localStorage.getItem('user_id') || localStorage.getItem('user_role') !== 'admin') {
    window.location.href = 'index.html';
}

// ЗВУК — работает 100%
let audioContext = null;
function playAlert() {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioContext.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = 900;
    const gain = audioContext.createGain();
    gain.gain.value = 0.4;
    osc.connect(gain);
    gain.connect(audioContext.destination);
    osc.start();
    osc.stop(audioContext.currentTime + 0.2);

    setTimeout(() => {
        const osc2 = audioContext.createOscillator();
        osc2.type = 'sine';
        osc2.frequency.value = 1200;
        osc2.connect(gain);
        osc2.start();
        osc2.stop(audioContext.currentTime + 0.2);
    }, 250);
}

let alertInterval = null;
let alertActive = false;

function startContinuousAlert() {
    if (alertActive) return;
    alertActive = true;
    alertInterval = setInterval(playAlert, 2000);
}

function stopContinuousAlert() {
    if (!alertActive) return;
    alertActive = false;
    clearInterval(alertInterval);
}

// Функция форматирования времени до фандинга
function formatFundingTime(nextFundingTime) {
    if (!nextFundingTime) return "—";
    
    const now = Date.now();
    const timeLeft = nextFundingTime - now;
    
    if (timeLeft <= 0) return "00:00:00";
    
    const totalSeconds = Math.floor(timeLeft / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

let previousBest = -999;

// Игнор-лист
let ignoreList = [];
const IGNORE_STORAGE_KEY = 'dashboard_ignore_list';

// Загрузить игнор-лист из localStorage
function loadIgnoreList() {
    const saved = localStorage.getItem(IGNORE_STORAGE_KEY);
    if (saved) {
        try {
            ignoreList = JSON.parse(saved);
            updateIgnoreUI();
        } catch (e) {
            console.error('Ошибка загрузки игнор-листа:', e);
            ignoreList = [];
        }
    }
}

// Сохранить игнор-лист в localStorage
function saveIgnoreList() {
    localStorage.setItem(IGNORE_STORAGE_KEY, JSON.stringify(ignoreList));
}

// Обновить игнор-лист из поля ввода
function updateIgnoreList() {
    const input = document.getElementById('ignore-list').value.trim().toUpperCase();
    
    if (!input) {
        // Очистить игнор-лист
        ignoreList = [];
        saveIgnoreList();
        updateIgnoreUI();
        update(); // Обновить таблицу
        return;
    }
    
    // Разделить по пробелам, запятым или переносам строк
    const newTickers = input.split(/[\s,]+/).filter(ticker => ticker.length > 0);
    
    // Добавить новые тикеры, убрать дубликаты
    ignoreList = [...new Set([...ignoreList, ...newTickers])];
    
    // Очистить поле ввода
    document.getElementById('ignore-list').value = '';
    
    // Сохранить и обновить UI
    saveIgnoreList();
    updateIgnoreUI();
    update(); // Обновить таблицу
    
    // Показать уведомление
    showIgnoreNotification(`Добавлено в игнор: ${newTickers.join(', ')}`);
}

// Обновить отображение игнор-листа
function updateIgnoreUI() {
    document.getElementById('ignore-count').textContent = ignoreList.length;
    
    // Показать список игнорируемых тикеров
    const ignoreStatus = document.getElementById('ignore-status');
    if (ignoreList.length > 0) {
        ignoreStatus.innerHTML = `Игнорируется: <span id="ignore-count" style="color:#ffa657;">${ignoreList.length}</span> тикеров
        <span id="ignore-clear" style="margin-left:10px; color:#58a6ff; cursor:pointer; font-size:0.8em;" onclick="clearIgnoreList()">[очистить]</span>`;
    } else {
        ignoreStatus.innerHTML = `Игнорируется: <span id="ignore-count">0</span> тикеров`;
    }
}

// Очистить игнор-лист
function clearIgnoreList() {
    if (confirm('Очистить весь игнор-лист?')) {
        ignoreList = [];
        saveIgnoreList();
        updateIgnoreUI();
        update(); // Обновить таблицу
        showIgnoreNotification('Игнор-лист очищен');
    }
}

// Удалить конкретный тикер из игнора
function removeFromIgnore(ticker) {
    ignoreList = ignoreList.filter(t => t !== ticker);
    saveIgnoreList();
    updateIgnoreUI();
    update(); // Обновить таблицу
    showIgnoreNotification(`Удален из игнора: ${ticker}`);
}

// Проверить, игнорируется ли тикер
function isIgnored(ticker) {
    return ignoreList.includes(ticker.toUpperCase());
}

// Показать уведомление об игноре
function showIgnoreNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(90deg, #ffa657, #ffc489);
        color: #000;
        padding: 12px 20px;
        border-radius: 10px;
        font-weight: bold;
        z-index: 9999;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        font-size: 0.9em;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// Функция для открытия графика спреда
function openSpreadChart(ticker) {
    const expr = `BINANCE:${ticker}USDT.P - BYBIT:${ticker}USDT.P`;
    window.open(`https://www.tradingview.com/chart/?symbol=${encodeURIComponent(expr)}`, '_blank');
}

function copyTicker(ticker, withUSDT = false) {
    const text = withUSDT ? ticker + 'USDT' : ticker;
    navigator.clipboard.writeText(text);
    const el = document.getElementById('copied');
    el.textContent = `Скопировано: ${text}`;
    el.style.opacity = 1;
    setTimeout(() => el.style.opacity = 0, 1500);
}

// Функция переключения калькулятора
function toggleCalculator() {
    const calc = document.querySelector('.spread-calc');
    const btn = document.querySelector('.toggle-calc-btn');
    
    if (calc.style.display === 'none') {
        calc.style.display = 'block';
        btn.textContent = 'Закрыть калькулятор';
        btn.classList.remove('calc-closed');
        btn.classList.add('calc-open');
    } else {
        calc.style.display = 'none';
        btn.textContent = 'Открыть калькулятор';
        btn.classList.remove('calc-open');
        btn.classList.add('calc-closed');
    }
}

async function calcSpread() {
    const input = document.getElementById('ticker-input').value.trim().toUpperCase();
    if (!input) return;
    const symbol = input + 'USDT';
    const cache = pricesCache[symbol] || {};
    const fund = fundingCache[symbol] || {};
    if (!cache.bybit || !cache.binance) {
        document.getElementById('calc-result').innerHTML = `<span style="color:#ff7b72">Монета ${input} не найдена</span>`;
        return;
    }

    const byPrice = cache.bybit;
    const bnPrice = cache.binance;
    const byRate = fund.bybit || 0;
    const bnRate = fund.binance || 0;

    const longOnBybit = byRate < bnRate;

    const fundingSpread = Math.abs(byRate - bnRate);
    const netFunding = fundingSpread - 0.25;
    const entryBonus = longOnBybit ? (bnPrice - byPrice) / byPrice * 100 : (byPrice - bnPrice) / bnPrice * 100;
    const totalProfit = netFunding + entryBonus;

    const direction = longOnBybit ?
        `<span style="color:#56d364">ЛОНГ Bybit</span> + <span style="color:#ff7b72">ШОРТ Binance</span>` :
        `<span style="color:#56d364">ЛОНГ Binance</span> + <span style="color:#ff7b72">ШОРТ Bybit</span>`;

    const totalColor = totalProfit >= 0.5 ? '#56d364' : totalProfit >= 0 ? '#ffa657' : '#ff7b72';

    document.getElementById('calc-result').innerHTML = `
        <div class="calc-title">${input}USDT — полный анализ</div>
        <div>Bybit цена: <strong>${byPrice.toFixed(6)}</strong> | Binance цена: <strong>${bnPrice.toFixed(6)}</strong></div>
        <div>Спред цены: <strong style="color:${entryBonus >= 0 ? '#56d364' : '#ff7b72'}">${entryBonus > 0 ? '+' : ''}${entryBonus.toFixed(3)}%</strong></div>
        <div>Bybit funding: <strong>${byRate.toFixed(5)}%</strong> | Binance funding: <strong>${bnRate.toFixed(5)}%</strong></div>
        <div>Спред фандинга: <strong>${fundingSpread.toFixed(4)}%</strong> → Чистый за 8ч: <strong>${netFunding.toFixed(4)}%</strong></div>
        <div style="margin-top:15px;">Направление: ${direction}</div>
        <div style="margin-top:15px; font-size:1.6em;" class="big-number" style="color:${totalColor}">
            Итого за 8ч ≈ <strong>${totalProfit > 0 ? '+' : ''}${totalProfit.toFixed(4)}%</strong>
            ${totalProfit >= 0.5 ? 'ВХОДИ СЕЙЧАС!' : totalProfit >= 0 ? '— Норм' : '— Пропусти'}
        </div>
    `;
}

let pricesCache = {};
let fundingCache = {};
let currentSort = 'totalProfit';
let currentSortDir = -1;

function setSort(field) {
    if (currentSort === field) {
        currentSortDir *= -1;
    } else {
        currentSort = field;
        currentSortDir = -1;
    }
    // Обновить стрелки в заголовках
    ['realFund','entryBonus','totalProfit'].forEach(f => {
        const th = document.getElementById('th-' + f);
        if (!th) return;
        const base = { realFund: 'Real Fund', entryBonus: 'Спред<br>текущий', totalProfit: 'Итого ≈' }[f];
        th.innerHTML = base + (currentSort === f ? (currentSortDir === -1 ? ' ▼' : ' ▲') : ' ↕');
    });
    renderRows();
}

async function update() {
    try {
        const binanceInfo = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r => r.json());
        const activeSymbols = new Set(binanceInfo.symbols.filter(s => s.status === 'TRADING' && s.contractType === 'PERPETUAL').map(s => s.symbol));

        const [bybitResp, binanceResp] = await Promise.all([
            fetch('https://api.bybit.com/v5/market/tickers?category=linear'),
            fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
        ]);
        
        const bybitData = await bybitResp.json();
        const binanceData = await binanceResp.json();

        const bybit = {}; 
        bybitData.result.list.forEach(t => { 
            if (t.symbol.endsWith('USDT')) bybit[t.symbol] = { 
                rate: parseFloat(t.fundingRate)*100, 
                next: parseInt(t.nextFundingTime), 
                price: parseFloat(t.markPrice || t.lastPrice) 
            }; 
        });

        const binance = {}; 
        binanceData.forEach(t => { 
            if (t.symbol.endsWith('USDT')) binance[t.symbol] = { 
                rate: parseFloat(t.lastFundingRate)*100, 
                next: parseInt(t.nextFundingTime), 
                price: parseFloat(t.markPrice) 
            }; 
        });


        pricesCache = {};
        fundingCache = {};

        const now = Date.now();
        const rows = [];
        let bestTotal = -999;

        for (const sym of Object.keys(bybit)) {
            if (!binance[sym] || !activeSymbols.has(sym)) continue;

            const br = bybit[sym].rate;
            const bn = binance[sym].rate;
            const byPrice = bybit[sym].price;
            const bnPrice = binance[sym].price;

            pricesCache[sym] = { bybit: byPrice, binance: bnPrice };
            fundingCache[sym] = { bybit: br, binance: bn };

            const longOnBybit = br < bn;

            const fundingSpread = Math.abs(br - bn);
            const netFunding = fundingSpread - 0.25;
            const entryBonus = longOnBybit ? (bnPrice - byPrice) / byPrice * 100 : (byPrice - bnPrice) / bnPrice * 100;

            if (Math.abs(entryBonus) > 10) continue;

            const totalProfit = netFunding + entryBonus;
            if (totalProfit > bestTotal) bestTotal = totalProfit;

            const ticker = sym.replace('USDT', '');

            // Проверить игнор-лист
            const isIgnoredTicker = isIgnored(ticker);
            const ignoreTag = isIgnoredTicker ? ' <span class="ignore-tag">игнорируется</span>' : '';

            // rowClass с учетом игнора
            let rowClass = '';
            if (!isIgnoredTicker && totalProfit >= parseFloat(document.getElementById('sound-threshold').value)) {
                rowClass = 'real-profit';
            }
            if (isIgnoredTicker) {
                rowClass += ' ignored-row';
            }

            const directionHTML = longOnBybit ?
                `<div class="direction"><span class="long">L BYBIT</span><span class="short">S BINANCE</span></div>` :
                `<div class="direction"><span class="long">L BINANCE</span><span class="short">S BYBIT</span></div>`;

            rows.push({totalProfit, realFund: fundingSpread, entryBonus, ticker, html: `
                <tr class="${rowClass}">
                    <td>
                        <span class="ticker" onclick="if(event.shiftKey) copyTicker('${ticker}', true); else copyTicker('${ticker}');"
                              oncontextmenu="if(isIgnored('${ticker}')) { event.preventDefault(); removeFromIgnore('${ticker}'); return false; }">
                            ${ticker}${ignoreTag}
                        </span>
                    </td>
                    <td><span class="spchart-btn" onclick="openSpreadChart('${ticker}')">spchart</span></td>
                    <td><span class="calc-btn" onclick="document.getElementById('ticker-input').value='${ticker}'; document.querySelector('.spread-calc').style.display='block'; document.querySelector('.toggle-calc-btn').textContent='Закрыть калькулятор'; document.querySelector('.toggle-calc-btn').classList.remove('calc-closed'); document.querySelector('.toggle-calc-btn').classList.add('calc-open'); calcSpread();">Calc</span></td>
                    <td>${fundingSpread.toFixed(4)}%</td>
                    <td class="${netFunding >= 0.1 ? 'lime' : netFunding >= 0 ? 'green' : 'red'}">${netFunding > 0 ? '+' : ''}${netFunding.toFixed(4)}%</td>
                    <td class="${entryBonus >= 0.2 ? 'lime' : entryBonus >= 0 ? 'green' : 'red'}">${entryBonus > 0 ? '+' : ''}${entryBonus.toFixed(3)}%</td>
                    <td style="font-weight:bold; font-size:1.1em;" class="${totalProfit >= 0.5 ? 'lime' : totalProfit >= 0 ? 'green' : 'red'}">
                        ${totalProfit > 0 ? '+' : ''}${totalProfit.toFixed(4)}%
                    </td>
                    <td>${directionHTML}</td>
                    <td>${br.toFixed(5)}%</td>
                    <td>${bn.toFixed(5)}%</td>
                    <td>${formatFundingTime(bybit[sym].next)}</td>
                    <td>${formatFundingTime(binance[sym].next)}</td>
                </tr>
            `});
        }

        // ЗВУК + МИГАНИЕ с учетом игнора
        const soundThreshold = parseFloat(document.getElementById('sound-threshold').value) || 0.5;
        const hasAlert = rows.some(r => !isIgnored(r.ticker) && r.totalProfit >= soundThreshold);

        if (hasAlert) {
            startContinuousAlert();
        } else {
            stopContinuousAlert();
        }

        previousBest = bestTotal;

        window._lastRows = rows;
        renderRows();
        document.getElementById('last-update').innerHTML = `Обновлено: ${new Date().toLocaleTimeString('ru-RU')}`;
    } catch (e) {
        console.error(e);
        document.getElementById('tbody').innerHTML = `<tr><td colspan="12" style="color:#ff7b72">Ошибка сети, повтор через 30 сек</td></tr>`;
        setTimeout(update, 30000); // Повтор через 30 сек при ошибке
    }
}

function renderRows() {
    const rows = window._lastRows || [];
    rows.sort((a, b) => b[currentSort] - a[currentSort]);
    const limit = parseInt(document.getElementById('limit-select').value) || 10;
    document.getElementById('tbody').innerHTML = rows.slice(0, limit).map(r => r.html).join('');
}

function updateNow() { 
    document.getElementById('last-update').innerHTML = "Обновляю..."; 
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    update(); 
}

setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleString('ru-RU'), 1000);
update();
setInterval(update, 15000);  // 15 секунд вместо 60

document.getElementById('ticker-input').addEventListener('keyup', e => { if (e.key === 'Enter') calcSpread(); });

// Обработчик Enter для поля игнор-листа
document.getElementById('ignore-list').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
        updateIgnoreList();
    }
});

// Модальное окно игнор-листа
function openIgnoreModal() {
    renderModalIgnoreList();
    document.getElementById('ignore-modal').style.display = 'flex';
}

function closeIgnoreModal() {
    document.getElementById('ignore-modal').style.display = 'none';
}

function renderModalIgnoreList() {
    const container = document.getElementById('modal-ignore-list');
    if (ignoreList.length === 0) {
        container.innerHTML = '<span style="color:#8b949e;">Список пуст</span>';
        return;
    }
    container.innerHTML = ignoreList.map(ticker => `
        <div style="display:flex; align-items:center; gap:6px; background:#0d1117; border:1px solid #30363d; border-radius:8px; padding:6px 10px;">
            <span style="color:#c9d1d9; font-weight:bold;">${ticker}</span>
            <span onclick="modalRemoveTicker('${ticker}')" style="cursor:pointer; color:#ff7b72; font-size:1.1em; line-height:1;">✕</span>
        </div>
    `).join('');
}

function modalRemoveTicker(ticker) {
    ignoreList = ignoreList.filter(t => t !== ticker);
    saveIgnoreList();
    updateIgnoreUI();
    renderModalIgnoreList();
    update();
}

function modalAddTicker() {
    const input = document.getElementById('modal-ignore-input');
    const tickers = input.value.trim().toUpperCase().split(/[\s,]+/).filter(t => t.length > 0);
    if (tickers.length === 0) return;
    ignoreList = [...new Set([...ignoreList, ...tickers])];
    saveIgnoreList();
    updateIgnoreUI();
    renderModalIgnoreList();
    input.value = '';
    update();
}

document.getElementById('modal-ignore-input').addEventListener('keyup', e => {
    if (e.key === 'Enter') modalAddTicker();
});

// Закрыть по клику вне окна
document.getElementById('ignore-modal').addEventListener('click', function(e) {
    if (e.target === this) closeIgnoreModal();
});

// Загрузить игнор-лист при старте
loadIgnoreList();

// Добавить анимацию для уведомлений
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
</body>
</html>



