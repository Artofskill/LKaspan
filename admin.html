<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artofskill ‚Äî –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</title>
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --text: #c9d1d9;
            --accent: #58a6ff;
            --accent2: #ffa657;
            --green: #56d364;
            --red: #ff7b72;
            --border: #30363d;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            touch-action: manipulation;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .header-left h1 {
            font-size: 2.8em;
            font-weight: 900;
            background: linear-gradient(90deg, #00f5ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        .header-left .subtitle {
            color: var(--accent2);
            font-size: 1.1em;
        }
        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .btn {
            padding: 12px 25px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--accent), #79c0ff);
            color: #000;
        }
        .btn-danger {
            background: linear-gradient(90deg, #ff6b6b, #ffa657);
            color: #000;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        /* –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã */
        .admin-tools {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 1.1em;
        }
        .search-box:before {
            content: 'üîç';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            opacity: 0.7;
        }
        .filters {
            display: flex;
            gap: 10px;
        }
        .filter-btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-btn.active {
            border-color: var(--accent);
            background: rgba(88,166,255,0.1);
            color: var(--accent);
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: var(--card);
            border-radius: 16px;
            padding: 25px;
            border: 2px solid var(--border);
        }
        .stat-card h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .stat-value {
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 10px;
        }
        .stat-change {
            font-size: 0.9em;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }
        .positive { color: var(--green); background: rgba(86,211,100,0.1); }
        .negative { color: var(--red); background: rgba(255,123,114,0.1); }
        
        /* –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .users-table-container {
            background: var(--card);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid var(--border);
            overflow-x: auto;
            margin-bottom: 40px;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .table-header h2 {
            color: var(--accent);
            font-size: 1.8em;
        }
        .users-table {
            width: 100%;
            border-collapse: collapse;
        }
        .users-table th {
            background: rgba(0,0,0,0.3);
            color: var(--accent2);
            padding: 18px 15px;
            text-align: left;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
            font-size: 1.1em;
            white-space: nowrap;
        }
        .users-table td {
            padding: 18px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .users-table tr:hover {
            background: rgba(88,166,255,0.05);
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }
        .status-active { background: rgba(86,211,100,0.2); color: var(--green); }
        .status-inactive { background: rgba(255,123,114,0.2); color: var(--red); }
        .status-pending { background: rgba(255,166,87,0.2); color: var(--accent2); }
        .role-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
            background: rgba(88,166,255,0.2);
            color: var(--accent);
        }
        .action-btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            background: rgba(88,166,255,0.2);
            color: var(--accent);
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 8px;
            font-size: 0.9em;
        }
        .action-btn:hover {
            background: var(--accent);
            color: #000;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--card);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .modal-header h2 {
            color: var(--accent);
            font-size: 1.8em;
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 2em;
            cursor: pointer;
            line-height: 1;
        }
        .modal-body .input-group {
            margin-bottom: 20px;
        }
        .modal-body label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent);
            font-weight: 600;
        }
        .modal-body input,
        .modal-body select {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 1em;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .header-left h1 { font-size: 2.2em; }
            .admin-tools { flex-direction: column; }
            .search-box { min-width: 100%; }
            .users-table { font-size: 0.9em; }
            .users-table th, .users-table td { padding: 12px 8px; }
            .stats-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
                    <select id="transaction-type">
                        <option value="deposit">–î–µ–ø–æ–∑–∏—Ç</option>
                        <option value="withdraw">–í—ã–≤–æ–¥</option>
                        <option value="dividend">–î–∏–≤–∏–¥–µ–Ω–¥—ã</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>–°—É–º–º–∞ ($)</label>
                    <input type="number" id="transaction-amount" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
                    <input type="text" id="transaction-hash" placeholder="0x...">
                </div>
                <div class="input-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" id="transaction-description" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                </div>
                <input type="hidden" id="selected-user-id">
                <button class="btn btn-primary" style="width:100%; padding:16px; margin-top:20px;" onclick="addTransaction()">
                    –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                </button>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Artofskill</h1>
                <div class="subtitle">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</div>
            </div>
            <div class="header-right">
                <div style="color: var(--accent); font-weight: 600; font-size: 1.1em;">
                    –ê–¥–º–∏–Ω: <span id="admin-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    –í—ã–π—Ç–∏
                </button>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-cards">
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                <div class="stat-value" id="total-users">0</div>
                <div class="stat-change positive" id="users-change">+0 —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-card">
                <h3>–û–±—â–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</h3>
                <div class="stat-value" id="total-investment">$0</div>
                <div class="stat-change positive" id="investment-change">+0% –∑–∞ –º–µ—Å—è—Ü</div>
            </div>
            <div class="stat-card">
                <h3>–í—ã–ø–ª–∞—Ç—ã –∑–∞ –º–µ—Å—è—Ü</h3>
                <div class="stat-value" id="monthly-payouts">$0</div>
                <div class="stat-change positive" id="payouts-change">+0 –≤—ã–ø–ª–∞—Ç</div>
            </div>
            <div class="stat-card">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <div class="stat-value" id="active-users">0</div>
                <div class="stat-change positive" id="active-change">+0 –∞–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
        </div>

        <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="admin-tools">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ email –∏–ª–∏ –∏–º–µ–Ω–∏..." onkeyup="searchUsers()">
            </div>
            <div class="filters">
                <button class="filter-btn active" onclick="filterUsers('all')">–í—Å–µ</button>
                <button class="filter-btn" onclick="filterUsers('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                <button class="filter-btn" onclick="filterUsers('inactive')">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</button>
                <button class="filter-btn" onclick="filterUsers('pending')">–û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</button>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="users-table-container">
            <div class="table-header">
                <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
                <div style="color: var(--accent2);" id="users-count">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
            </div>
            <table class="users-table" id="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>–ò–º—è</th>
                        <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                        <th>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</th>
                        <th>–°–ª–µ–¥. –≤—ã–ø–ª–∞—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–†–æ–ª—å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–ò –î–ê–ù–ù–´–ï)
        const SUPABASE_URL = 'https://tusekrsokkmjtlkvgyvq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_-qYVqquSGHd3z53UDHxWGw_Tvq9358W';

        let allUsers = [];
        let currentFilter = 'all';
        let currentUserId = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
        document.addEventListener('DOMContentLoaded', async function() {
            const userRole = localStorage.getItem('user_role');
            const username = localStorage.getItem('username');
            
            if (userRole !== 'admin') {
                alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.');
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('admin-name').textContent = username || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            
            await loadUsers();
            await loadStats();
        });

        async function loadUsers() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                
                allUsers = await response.json();
                renderUsers(allUsers);
                
            } catch (error) {
                console.error('Error loading users:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            }
        }

        async function loadStats() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
                const transactionsRes = await fetch(`${SUPABASE_URL}/rest/v1/transactions`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                const transactions = await transactionsRes.json();
                
                // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const totalInvestment = allUsers.reduce((sum, user) => sum + (parseFloat(user.total_investment) || 0), 0);
                const activeUsers = allUsers.filter(u => u.status === 'active').length;
                const monthlyPayouts = transactions
                    .filter(t => t.type === 'dividend')
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                document.getElementById('total-users').textContent = allUsers.length;
                document.getElementById('total-investment').textContent = `$${totalInvestment.toLocaleString('ru-RU', { minimumFractionDigits: 2 })}`;
                document.getElementById('monthly-payouts').textContent = `$${monthlyPayouts.toLocaleString('ru-RU', { minimumFractionDigits: 2 })}`;
                document.getElementById('active-users').textContent = activeUsers;
                
                // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —Å—á–∏—Ç–∞–π—Ç–µ –∏–∑ –±–∞–∑—ã)
                document.getElementById('users-change').textContent = `+${Math.floor(allUsers.length * 0.1)} –∑–∞ –Ω–µ–¥–µ–ª—é`;
                document.getElementById('investment-change').textContent = `+${Math.floor(totalInvestment * 0.05).toLocaleString()} –∑–∞ –º–µ—Å—è—Ü`;
                document.getElementById('payouts-change').textContent = `+${Math.floor(monthlyPayouts * 0.08).toLocaleString()} –∑–∞ –Ω–µ–¥–µ–ª—é`;
                document.getElementById('active-change').textContent = `+${Math.floor(activeUsers * 0.12)} –∑–∞ –º–µ—Å—è—Ü`;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            const filteredUsers = filterUserList(users);
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
                const regDate = new Date(user.registration_date).toLocaleDateString('ru-RU');
                const nextPayment = user.next_payment_date ? 
                    new Date(user.next_payment_date).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                
                row.innerHTML = `
                    <td>${user.id.substring(0, 8)}...</td>
                    <td>${user.email}</td>
                    <td>${user.username}</td>
                    <td>${regDate}</td>
                    <td>$${(parseFloat(user.total_investment) || 0).toFixed(2)}</td>
                    <td>${nextPayment}</td>
                    <td><span class="status-badge status-${user.status || 'active'}">${user.status || 'active'}</span></td>
                    <td><span class="role-badge">${user.role || 'user'}</span></td>
                    <td>
                        <button class="action-btn" onclick="openTransactionModal('${user.id}')">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</button>
                        <button class="action-btn" onclick="editUser('${user.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('users-count').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${filteredUsers.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;
        }

        function filterUserList(users) {
            switch(currentFilter) {
                case 'active': return users.filter(u => u.status === 'active');
                case 'inactive': return users.filter(u => u.status === 'inactive');
                case 'pending': 
                    const today = new Date();
                    return users.filter(u => {
                        const paymentDate = new Date(u.next_payment_date);
                        return paymentDate <= today && u.status === 'active';
                    });
                default: return users;
            }
        }

        function filterUsers(filter) {
            currentFilter = filter;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderUsers(allUsers);
        }

        function searchUsers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) {
                renderUsers(allUsers);
                return;
            }
            
            const filtered = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm) ||
                user.username.toLowerCase().includes(searchTerm)
            );
            
            renderUsers(filtered);
        }

        function openTransactionModal(userId) {
            currentUserId = userId;
            document.getElementById('selected-user-id').value = userId;
            document.getElementById('transactionModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('transactionModal').style.display = 'none';
            resetModal();
        }

        function resetModal() {
            document.getElementById('transaction-type').value = 'deposit';
            document.getElementById('transaction-amount').value = '';
            document.getElementById('transaction-hash').value = '';
            document.getElementById('transaction-description').value = '';
            currentUserId = null;
        }

        async function addTransaction() {
            const type = document.getElementById('transaction-type').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const hash = document.getElementById('transaction-hash').value.trim();
            const description = document.getElementById('transaction-description').value.trim();
            const userId = currentUserId;

            if (!amount || amount <= 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }

            try {
                // 1. –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                const transactionResponse = await fetch(`${SUPABASE_URL}/rest/v1/transactions`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        type: type,
                        amount: amount,
                        transaction_hash: hash,
                        description: description,
                        status: 'completed',
                        date: new Date().toISOString()
                    })
                });

                if (!transactionResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');

                // 2. –ï—Å–ª–∏ —ç—Ç–æ –¥–µ–ø–æ–∑–∏—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (type === 'deposit') {
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userResponse = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    });
                    
                    const userData = await userResponse.json();
                    if (userData.length > 0) {
                        const currentInvestment = parseFloat(userData[0].total_investment) || 0;
                        const newInvestment = currentInvestment + amount;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
                        await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                total_investment: newInvestment
                            })
                        });
                    }
                }

                // 3. –ï—Å–ª–∏ —ç—Ç–æ –¥–∏–≤–∏–¥–µ–Ω–¥—ã, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–π –≤—ã–ø–ª–∞—Ç—ã
                if (type === 'dividend') {
                    const nextPaymentDate = new Date();
                    nextPaymentDate.setMonth(nextPaymentDate.getMonth() + 1);
                    
                    await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            next_payment_date: nextPaymentDate.toISOString().split('T')[0]
                        })
                    });
                }

                alert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                closeModal();
                await loadUsers();
                await loadStats();
                
            } catch (error) {
                console.error('Error adding transaction:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }
        }

        async function editUser(userId) {
            const newStatus = prompt('–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å (active/inactive):', 'active');
            
            if (newStatus && ['active', 'inactive'].includes(newStatus.toLowerCase())) {
                try {
                    await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: newStatus.toLowerCase()
                        })
                    });
                    
                    alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    await loadUsers();
                    
                } catch (error) {
                    console.error('Error updating user:', error);
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            }
        }

        function showError(message) {
            alert(message);
        }

        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('transactionModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>

</body>
</html>